generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organization {
  id                   String                     @id @default(cuid())
  name                 String
  domain               String?                    @unique
  settings             Json?
  plan                 String                     @default("free")
  stripeCustomerId     String?
  isActive             Boolean                    @default(true)
  createdAt            DateTime                   @default(now())
  updatedAt            DateTime                   @updatedAt
  activities           Activity[]
  apiKeys              APIKey[]
  billingEvents        BillingEvent[]
  controls             Control[]
  documents            Document[]
  encryptionKeys       EncryptionKey[]
  extractedControls    ExtractedControl[]
  extractedRisks       ExtractedRisk[]
  subscriptions        OrganizationSubscription[]
  questionnaires       Questionnaire[]
  rcsaEntries          RcsaEntry[]
  reports              Report[]
  risks                Risk[]
  spreadsheetTemplates SpreadsheetTemplate[]      @relation("SpreadsheetTemplateOrg")
  spreadsheets         Spreadsheet[]
  tasks                Task[]
  users                User[]
  workflows            Workflow[]
  workflows_v2         WorkflowV2[]
  proboControls        ProboControl[]
  proboTasks           ProboTask[]
  proboEvidence        ProboEvidence[]
  vendorAssessments    VendorAssessment[]
  complianceFrameworks ComplianceFramework[]

  @@map("organizations")
}

model User {
  id                       String                   @id @default(cuid())
  email                    String                   @unique
  firstName                String
  lastName                 String
  passwordHash             String?
  avatar                   String?
  phoneNumber              String?
  role                     UserRole                 @default(USER)
  permissions              String[]                 @default([])
  isActive                 Boolean                  @default(true)
  emailVerified            DateTime?
  emailVerificationToken   String?
  emailVerificationExpires DateTime?
  passwordResetToken       String?
  passwordResetExpires     DateTime?
  lastLogin                DateTime?
  organizationId           String
  createdAt                DateTime                 @default(now())
  updatedAt                DateTime                 @updatedAt
  createdActivities        Activity[]               @relation("ActivityCreatedBy")
  aiConversations          AIConversation[]
  aiUsageLogs              AIUsageLog[]
  comments                 Comment[]
  createdControls          Control[]                @relation("ControlCreatedBy")
  assignedControls         Control[]                @relation("ControlAssignedTo")
  createdDocuments         Document[]               @relation("DocumentCreatedBy")
  createdExtractedControls ExtractedControl[]       @relation("ExtractedControlCreatedBy")
  createdExtractedRisks    ExtractedRisk[]          @relation("ExtractedRiskCreatedBy")
  messages                 Message[]                @relation("MessageSender")
  notificationPreferences  NotificationPreferences?
  notifications            Notification[]
  createdQuestionnaires    Questionnaire[]          @relation("QuestionnaireCreatedBy")
  createdRcsaEntries       RcsaEntry[]              @relation("RcsaEntryCreatedBy")
  createdReports           Report[]                 @relation("ReportCreatedBy")
  responses                Response[]
  createdRisks             Risk[]                   @relation("RiskCreatedBy")
  assignedRisks            Risk[]                   @relation("RiskAssignedTo")
  sessions                 Session[]
  cellComments             SpreadsheetCellComment[] @relation("SpreadsheetCellCommentUser")
  modifiedCells            SpreadsheetCell[]        @relation("SpreadsheetCellModifier")
  spreadsheetPermissions   SpreadsheetPermission[]  @relation("SpreadsheetPermissionUser")
  createdTemplates         SpreadsheetTemplate[]    @relation("SpreadsheetTemplateCreator")
  spreadsheetVersions      SpreadsheetVersion[]     @relation("SpreadsheetVersionUser")
  createdSpreadsheets      Spreadsheet[]            @relation("SpreadsheetCreatedBy")
  assignedTasks            Task[]                   @relation("TaskAssignedTo")
  createdTasks             Task[]                   @relation("TaskCreatedBy")
  organization             Organization             @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  assignedWorkflowSteps    WorkflowStep[]           @relation("WorkflowStepAssignedTo")
  createdWorkflows         Workflow[]               @relation("WorkflowCreatedBy")
  receivedMessages         Message[]                @relation("MessageRecipient")

  @@index([organizationId])
  @@index([email])
  @@map("users")
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  ipAddress String?
  userAgent String?
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@map("sessions")
}

model Risk {
  id              String               @id @default(cuid())
  title           String
  description     String
  category        RiskCategory
  likelihood      Int                  @default(1)
  impact          Int                  @default(1)
  riskScore       Int                  @default(1)
  riskLevel       RiskLevel?
  owner           String?
  status          RiskStatus           @default(IDENTIFIED)
  dateIdentified  DateTime?
  lastAssessed    DateTime?
  nextReview      DateTime?
  aiConfidence    Float?
  organizationId  String
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  createdBy       String?
  controls        ControlRiskMapping[]
  creator         User?                @relation("RiskCreatedBy", fields: [createdBy], references: [id])
  organization    Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  assignedUser    User?                @relation("RiskAssignedTo", fields: [owner], references: [id])
  spreadsheetRows SpreadsheetRow[]     @relation("SpreadsheetRowRisk")
  tasks           Task[]
  evidence        Document[]           @relation("RiskEvidence")

  @@index([organizationId])
  @@index([category])
  @@index([status])
  @@index([riskLevel])
  @@index([createdAt])
  @@map("risks")
}

model ControlRiskMapping {
  id            String   @id @default(cuid())
  riskId        String
  controlId     String
  effectiveness Float    @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  control       Control  @relation(fields: [controlId], references: [id], onDelete: Cascade)
  risk          Risk     @relation(fields: [riskId], references: [id], onDelete: Cascade)

  @@unique([riskId, controlId])
  @@map("control_risk_mappings")
}

model Control {
  id                  String               @id @default(cuid())
  title               String
  description         String
  type                ControlType
  category            ControlCategory      @default(OPERATIONAL)
  frequency           String
  automationLevel     AutomationLevel      @default(MANUAL)
  effectiveness       Float                @default(0)
  effectivenessRating EffectivenessRating?
  owner               String?
  operatorId          String?
  reviewerId          String?
  status              ControlStatus        @default(PLANNED)
  priority            Priority?
  lastTestDate        DateTime?
  nextTestDate        DateTime?
  testResults         String?
  businessUnit        String?
  department          String?
  location            String?
  cost                Float?
  effort              ControlEffort?
  tags                String[]             @default([])
  customFields        Json?
  organizationId      String
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  createdBy           String?
  risks               ControlRiskMapping[]
  creator             User?                @relation("ControlCreatedBy", fields: [createdBy], references: [id])
  organization        Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  assignedUser        User?                @relation("ControlAssignedTo", fields: [owner], references: [id])
  spreadsheetRows     SpreadsheetRow[]     @relation("SpreadsheetRowControl")
  tasks               Task[]
  evidence            Document[]           @relation("ControlEvidence")

  @@index([organizationId])
  @@index([type])
  @@index([status])
  @@index([category])
  @@index([createdAt])
  @@map("controls")
}

model Document {
  id              String       @id @default(cuid())
  name            String
  type            String
  size            Int
  content         String?
  extractedText   String?
  aiAnalysis      Json?
  uploadedAt      DateTime     @default(now())
  organizationId  String
  uploadedBy      String?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  uploader        User?        @relation("DocumentCreatedBy", fields: [uploadedBy], references: [id])
  controlEvidence Control[]    @relation("ControlEvidence")
  riskEvidence    Risk[]       @relation("RiskEvidence")

  @@index([organizationId])
  @@index([type])
  @@index([uploadedAt])
  @@map("documents")
}

model RcsaEntry {
  id              String         @id @default(cuid())
  riskId          String
  riskDescription String
  organizationId  String
  uploadedBy      String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  controls        ControlEntry[]
  organization    Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  uploader        User?          @relation("RcsaEntryCreatedBy", fields: [uploadedBy], references: [id])

  @@unique([riskId, organizationId])
  @@index([organizationId])
  @@index([riskId])
  @@index([createdAt])
  @@map("rcsa_entries")
}

model ControlEntry {
  id                 String    @id @default(cuid())
  controlId          String
  controlDescription String
  rcsaEntryId        String
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  rcsaEntry          RcsaEntry @relation(fields: [rcsaEntryId], references: [id], onDelete: Cascade)

  @@index([rcsaEntryId])
  @@index([controlId])
  @@index([createdAt])
  @@map("control_entries")
}

model ExtractedRisk {
  id             String       @id @default(cuid())
  externalId     String
  text           String
  sourceDocument String
  extractedAt    DateTime     @default(now())
  confidence     Float?
  organizationId String
  extractedBy    String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  extractor      User?        @relation("ExtractedRiskCreatedBy", fields: [extractedBy], references: [id])
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([sourceDocument])
  @@index([extractedAt])
  @@map("extracted_risks")
}

model ExtractedControl {
  id             String       @id @default(cuid())
  externalId     String
  text           String
  sourceDocument String
  extractedAt    DateTime     @default(now())
  confidence     Float?
  organizationId String
  extractedBy    String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  extractor      User?        @relation("ExtractedControlCreatedBy", fields: [extractedBy], references: [id])
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([sourceDocument])
  @@index([extractedAt])
  @@map("extracted_controls")
}

model Questionnaire {
  id             String              @id @default(cuid())
  title          String
  description    String
  questions      Json
  targetRoles    String[]            @default([])
  status         QuestionnaireStatus @default(DRAFT)
  dueDate        DateTime?
  estimatedTime  Int?
  tags           String[]            @default([])
  organizationId String
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  createdBy      String?
  creator        User?               @relation("QuestionnaireCreatedBy", fields: [createdBy], references: [id])
  organization   Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  responses      Response[]

  @@index([organizationId])
  @@index([status])
  @@index([createdAt])
  @@map("questionnaires")
}

model Response {
  id              String        @id @default(cuid())
  questionnaireId String
  questionId      String
  userId          String
  answer          Json
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  questionnaire   Questionnaire @relation(fields: [questionnaireId], references: [id], onDelete: Cascade)
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([questionnaireId])
  @@index([userId])
  @@map("responses")
}

model Workflow {
  id                      String                @id @default(cuid())
  name                    String
  description             String
  type                    WorkflowType
  steps                   Json
  status                  WorkflowStatus        @default(DRAFT)
  assignedTo              String[]              @default([])
  priority                Priority              @default(MEDIUM)
  completedAt             DateTime?
  tags                    String[]              @default([])
  relatedEntities         Json?
  organizationId          String
  createdAt               DateTime              @default(now())
  updatedAt               DateTime              @updatedAt
  createdBy               String?
  spreadsheetIntegrations SpreadsheetWorkflow[] @relation("SpreadsheetWorkflowIntegration")
  creator                 User?                 @relation("WorkflowCreatedBy", fields: [createdBy], references: [id])
  organization            Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([status])
  @@index([type])
  @@index([createdAt])
  @@map("workflows")
}

model WorkflowV2 {
  id             String         @id @default(cuid())
  name           String
  description    String
  type           WorkflowType
  status         WorkflowStatus @default(DRAFT)
  priority       Priority       @default(MEDIUM)
  completedAt    DateTime?
  organizationId String
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  createdBy      String?
  steps          WorkflowStep[]
  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([status])
  @@map("workflows_v2")
}

model WorkflowStep {
  id          String           @id @default(cuid())
  workflowId  String
  name        String
  type        WorkflowStepType
  assigneeId  String?
  status      StepStatus       @default(PENDING)
  dueDate     DateTime?
  completedAt DateTime?
  completedBy String?
  order       Int
  conditions  Json?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  assignee    User?            @relation("WorkflowStepAssignedTo", fields: [assigneeId], references: [id])
  workflow    WorkflowV2       @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([workflowId])
  @@index([assigneeId])
  @@map("workflow_steps")
}

model Report {
  id             String       @id @default(cuid())
  title          String
  type           ReportType
  status         ReportStatus @default(DRAFT)
  data           Json?
  parameters     Json?
  sharedWith     String[]     @default([])
  exportFormats  String[]     @default([])
  organizationId String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  createdBy      String?
  creator        User?        @relation("ReportCreatedBy", fields: [createdBy], references: [id])
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([type])
  @@index([status])
  @@map("reports")
}

model Task {
  id              String           @id @default(cuid())
  title           String
  description     String?
  type            TaskType
  status          TaskStatus       @default(TODO)
  priority        Priority         @default(MEDIUM)
  assigneeId      String?
  assignedBy      String?
  dueDate         DateTime?
  completedAt     DateTime?
  estimatedHours  Int?
  actualHours     Int?
  tags            String[]         @default([])
  riskId          String?
  controlId       String?
  organizationId  String
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  createdBy       String?
  spreadsheetRows SpreadsheetRow[] @relation("SpreadsheetRowTask")
  assignee        User?            @relation("TaskAssignedTo", fields: [assigneeId], references: [id])
  control         Control?         @relation(fields: [controlId], references: [id])
  creator         User?            @relation("TaskCreatedBy", fields: [createdBy], references: [id])
  organization    Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  risk            Risk?            @relation(fields: [riskId], references: [id])

  @@index([organizationId])
  @@index([assigneeId])
  @@index([status])
  @@index([dueDate])
  @@map("tasks")
}

model Message {
  id           String        @id @default(cuid())
  content      String
  type         MessageType   @default(DIRECT)
  status       MessageStatus @default(SENT)
  senderId     String
  recipientIds String[]      @default([])
  threadId     String?
  mentions     String[]      @default([])
  attachments  Json?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  sender       User          @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  recipients   User[]        @relation("MessageRecipient")

  @@index([senderId])
  @@index([threadId])
  @@index([createdAt])
  @@map("messages")
}

model Comment {
  id          String     @id @default(cuid())
  content     String
  authorId    String
  entityType  EntityType
  entityId    String
  parentId    String?
  mentions    String[]   @default([])
  attachments Json?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  author      User       @relation(fields: [authorId], references: [id], onDelete: Cascade)
  parent      Comment?   @relation("CommentReplies", fields: [parentId], references: [id])
  replies     Comment[]  @relation("CommentReplies")

  @@index([entityType, entityId])
  @@index([authorId])
  @@index([createdAt])
  @@map("comments")
}

model Notification {
  id                String           @id @default(cuid())
  type              NotificationType
  title             String
  message           String
  read              Boolean          @default(false)
  isRead            Boolean          @default(false)
  readAt            DateTime?
  deliveredAt       DateTime?
  userId            String
  recipientId       String
  senderId          String?          @default("system")
  entityType        String?          @default("SYSTEM")
  entityId          String?          @default("system")
  actionUrl         String?
  relatedEntityType String?
  relatedEntityId   String?
  priority          Priority         @default(MEDIUM)
  includeInDigest   Boolean          @default(false)
  pendingDigest     Boolean          @default(false)
  digestFrequency   String?
  digestSentAt      DateTime?
  createdAt         DateTime         @default(now())
  user              User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([recipientId])
  @@index([read])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

model Activity {
  id             String        @id @default(cuid())
  type           ActivityType
  userId         String?
  entityType     EntityType
  entityId       String
  description    String
  metadata       Json?
  isPublic       Boolean       @default(true)
  organizationId String
  createdAt      DateTime      @default(now())
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User?         @relation("ActivityCreatedBy", fields: [userId], references: [id])

  @@index([organizationId])
  @@index([entityType, entityId])
  @@index([userId])
  @@index([createdAt])
  @@map("activities")
}

model AIConversation {
  id             String   @id @default(cuid())
  userId         String
  title          String
  agentType      String
  messages       Json
  context        Json?
  status         String   @default("active")
  tokenUsage     Int      @default(0)
  estimatedCost  Float    @default(0)
  organizationId String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([userId])
  @@index([createdAt])
  @@map("ai_conversations")
}

model AIUsageLog {
  id               String   @id @default(cuid())
  userId           String
  requestType      String
  promptTokens     Int
  completionTokens Int
  totalTokens      Int
  estimatedCost    Float
  responseTime     Int
  success          Boolean  @default(true)
  errorMessage     String?
  organizationId   String
  createdAt        DateTime @default(now())
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([userId])
  @@index([createdAt])
  @@map("ai_usage_logs")
}

model NotificationPreferences {
  id         String   @id @default(cuid())
  userId     String   @unique
  email      Json
  push       Json
  sms        Json
  slack      Json
  inApp      Json
  quietHours Json
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notification_preferences")
}

model EncryptionKey {
  id             String       @id @default(cuid())
  purpose        String
  encryptedKey   String
  algorithm      String
  status         String       @default("active")
  version        Int          @default(1)
  metadata       Json?
  organizationId String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  rotatedAt      DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([purpose])
  @@index([status])
  @@map("encryption_keys")
}

model EncryptionKeyHistory {
  id           String   @id @default(cuid())
  keyId        String
  version      Int
  encryptedKey String
  rotatedAt    DateTime
  reason       String
  createdAt    DateTime @default(now())

  @@index([keyId])
  @@map("encryption_key_history")
}

model SubscriptionPlan {
  id              String                     @id @default(cuid())
  name            String
  description     String
  type            String
  price           Float
  currency        String                     @default("USD")
  billingInterval String
  features        Json
  limits          Json
  isActive        Boolean                    @default(true)
  trialDays       Int                        @default(0)
  stripeProductId String?
  stripePriceId   String?
  createdAt       DateTime                   @default(now())
  updatedAt       DateTime                   @updatedAt
  subscriptions   OrganizationSubscription[]

  @@map("subscription_plans")
}

model OrganizationSubscription {
  id                   String           @id @default(cuid())
  organizationId       String
  planId               String
  stripeSubscriptionId String?
  stripeCustomerId     String?
  status               String
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  trialStart           DateTime?
  trialEnd             DateTime?
  canceledAt           DateTime?
  cancelAtPeriodEnd    Boolean          @default(false)
  billingCycle         String
  quantity             Int              @default(1)
  unitPrice            Float
  metadata             Json?
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt
  invoices             Invoice[]
  organization         Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  plan                 SubscriptionPlan @relation(fields: [planId], references: [id])
  usageRecords         UsageRecord[]

  @@index([organizationId])
  @@index([stripeSubscriptionId])
  @@map("organization_subscriptions")
}

model PaymentMethod {
  id                    String   @id @default(cuid())
  organizationId        String
  stripePaymentMethodId String
  type                  String
  card                  Json?
  bankAccount           Json?
  isDefault             Boolean  @default(false)
  isActive              Boolean  @default(true)
  metadata              Json?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([organizationId])
  @@map("payment_methods")
}

model Invoice {
  id              String                    @id @default(cuid())
  organizationId  String
  subscriptionId  String?
  stripeInvoiceId String?                   @unique
  invoiceNumber   String
  status          String
  type            String
  subtotal        Float
  taxAmount       Float                     @default(0)
  discountAmount  Float                     @default(0)
  total           Float
  currency        String                    @default("USD")
  billingPeriod   Json?
  lineItems       Json
  dueDate         DateTime
  paidAt          DateTime?
  metadata        Json?
  createdAt       DateTime                  @default(now())
  updatedAt       DateTime                  @updatedAt
  subscription    OrganizationSubscription? @relation(fields: [subscriptionId], references: [id])

  @@index([organizationId])
  @@index([subscriptionId])
  @@map("invoices")
}

model UsageRecord {
  id             String                   @id @default(cuid())
  organizationId String
  subscriptionId String
  metricType     String
  quantity       Float
  unitPrice      Float                    @default(0)
  total          Float                    @default(0)
  period         DateTime
  metadata       Json?
  createdAt      DateTime                 @default(now())
  subscription   OrganizationSubscription @relation(fields: [subscriptionId], references: [id])

  @@index([organizationId])
  @@index([subscriptionId])
  @@index([metricType])
  @@index([period])
  @@map("usage_records")
}

model BillingEvent {
  id             String       @id @default(cuid())
  organizationId String
  type           String
  eventData      Json
  stripeEventId  String?      @unique
  processed      Boolean      @default(false)
  processedAt    DateTime?
  errorMessage   String?
  retryCount     Int          @default(0)
  nextRetryAt    DateTime?
  createdAt      DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId])
  @@index([type])
  @@index([processed])
  @@map("billing_events")
}

model APIKey {
  id             String       @id @default(cuid())
  organizationId String
  name           String
  description    String?
  key            String       @unique
  hashedKey      String       @unique
  permissions    String[]
  ipWhitelist    String[]
  lastUsedAt     DateTime?
  expiresAt      DateTime?
  isActive       Boolean      @default(true)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([hashedKey])
  @@map("api_keys")
}

model Spreadsheet {
  id             String                  @id @default(cuid())
  organizationId String
  name           String
  description    String?
  templateType   SpreadsheetType
  isTemplate     Boolean                 @default(false)
  createdBy      String
  createdAt      DateTime                @default(now())
  updatedAt      DateTime                @updatedAt
  permissions    SpreadsheetPermission[]
  sheets         SpreadsheetSheet[]
  versions       SpreadsheetVersion[]
  workflows      SpreadsheetWorkflow[]
  creator        User                    @relation("SpreadsheetCreatedBy", fields: [createdBy], references: [id])
  organization   Organization            @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([templateType])
  @@index([createdBy])
  @@map("spreadsheets")
}

model SpreadsheetSheet {
  id            String              @id @default(cuid())
  spreadsheetId String
  name          String
  position      Int
  isHidden      Boolean             @default(false)
  settings      Json?
  columns       SpreadsheetColumn[]
  rows          SpreadsheetRow[]
  spreadsheet   Spreadsheet         @relation(fields: [spreadsheetId], references: [id], onDelete: Cascade)

  @@index([spreadsheetId])
  @@map("spreadsheet_sheets")
}

model SpreadsheetColumn {
  id              String            @id @default(cuid())
  sheetId         String
  name            String
  position        Int
  dataType        ColumnDataType
  isRequired      Boolean           @default(false)
  isCalculated    Boolean           @default(false)
  formula         String?
  width           Int               @default(150)
  linkedEntity    String?
  linkedField     String?
  validationRules Json?
  dropdownOptions String[]
  formatSettings  Json?
  cells           SpreadsheetCell[]
  sheet           SpreadsheetSheet  @relation(fields: [sheetId], references: [id], onDelete: Cascade)

  @@index([sheetId])
  @@map("spreadsheet_columns")
}

model SpreadsheetRow {
  id              String            @id @default(cuid())
  sheetId         String
  position        Int
  isHidden        Boolean           @default(false)
  height          Int               @default(40)
  linkedRiskId    String?
  linkedControlId String?
  linkedTaskId    String?
  cells           SpreadsheetCell[]
  linkedControl   Control?          @relation("SpreadsheetRowControl", fields: [linkedControlId], references: [id])
  linkedRisk      Risk?             @relation("SpreadsheetRowRisk", fields: [linkedRiskId], references: [id])
  linkedTask      Task?             @relation("SpreadsheetRowTask", fields: [linkedTaskId], references: [id])
  sheet           SpreadsheetSheet  @relation(fields: [sheetId], references: [id], onDelete: Cascade)

  @@index([sheetId])
  @@index([linkedRiskId])
  @@index([linkedControlId])
  @@map("spreadsheet_rows")
}

model SpreadsheetCell {
  id             String                   @id @default(cuid())
  rowId          String
  columnId       String
  value          Json?
  displayValue   String?
  isLocked       Boolean                  @default(false)
  lastModifiedBy String
  lastModifiedAt DateTime                 @default(now())
  formatting     Json?
  comments       SpreadsheetCellComment[]
  column         SpreadsheetColumn        @relation(fields: [columnId], references: [id], onDelete: Cascade)
  modifier       User                     @relation("SpreadsheetCellModifier", fields: [lastModifiedBy], references: [id])
  row            SpreadsheetRow           @relation(fields: [rowId], references: [id], onDelete: Cascade)

  @@unique([rowId, columnId])
  @@index([rowId])
  @@index([columnId])
  @@index([lastModifiedBy])
  @@map("spreadsheet_cells")
}

model SpreadsheetCellComment {
  id        String                   @id @default(cuid())
  cellId    String
  userId    String
  content   String
  createdAt DateTime                 @default(now())
  updatedAt DateTime                 @updatedAt
  resolved  Boolean                  @default(false)
  parentId  String?
  cell      SpreadsheetCell          @relation(fields: [cellId], references: [id], onDelete: Cascade)
  parent    SpreadsheetCellComment?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies   SpreadsheetCellComment[] @relation("CommentReplies")
  user      User                     @relation("SpreadsheetCellCommentUser", fields: [userId], references: [id])

  @@index([cellId])
  @@index([userId])
  @@map("spreadsheet_cell_comments")
}

model SpreadsheetPermission {
  id            String                    @id @default(cuid())
  spreadsheetId String
  userId        String
  permission    SpreadsheetPermissionType
  createdAt     DateTime                  @default(now())
  updatedAt     DateTime                  @updatedAt
  spreadsheet   Spreadsheet               @relation(fields: [spreadsheetId], references: [id], onDelete: Cascade)
  user          User                      @relation("SpreadsheetPermissionUser", fields: [userId], references: [id])

  @@unique([spreadsheetId, userId])
  @@index([spreadsheetId])
  @@index([userId])
  @@map("spreadsheet_permissions")
}

model SpreadsheetWorkflow {
  id            String      @id @default(cuid())
  spreadsheetId String
  workflowId    String
  triggerType   String
  triggerConfig Json?
  isActive      Boolean     @default(true)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  spreadsheet   Spreadsheet @relation(fields: [spreadsheetId], references: [id], onDelete: Cascade)
  workflow      Workflow    @relation("SpreadsheetWorkflowIntegration", fields: [workflowId], references: [id])

  @@index([spreadsheetId])
  @@index([workflowId])
  @@map("spreadsheet_workflows")
}

model SpreadsheetVersion {
  id            String      @id @default(cuid())
  spreadsheetId String
  version       Int
  changedBy     String
  changes       Json
  createdAt     DateTime    @default(now())
  description   String?
  user          User        @relation("SpreadsheetVersionUser", fields: [changedBy], references: [id])
  spreadsheet   Spreadsheet @relation(fields: [spreadsheetId], references: [id], onDelete: Cascade)

  @@index([spreadsheetId])
  @@index([version])
  @@map("spreadsheet_versions")
}

model SpreadsheetTemplate {
  id             String          @id @default(cuid())
  organizationId String?
  name           String
  description    String
  category       String
  templateType   SpreadsheetType
  config         Json
  isPublic       Boolean         @default(false)
  isActive       Boolean         @default(true)
  usageCount     Int             @default(0)
  createdBy      String
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  creator        User            @relation("SpreadsheetTemplateCreator", fields: [createdBy], references: [id])
  organization   Organization?   @relation("SpreadsheetTemplateOrg", fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([templateType])
  @@index([category])
  @@map("spreadsheet_templates")
}

model ProboControl {
  id                        String                 @id @default(cuid())
  controlId                 String
  title                     String
  name                      String
  category                  String
  importance               String                 @default("PREFERRED")
  standards                String[]               @default([])
  description              String
  status                   String                 @default("NOT_IMPLEMENTED")
  assignedTo               String?
  dueDate                  DateTime?
  completedDate            DateTime?
  riskReduction            Int                    @default(0)
  implementationEffort     String                 @default("MEDIUM")
  implementationComplexity String                 @default("MEDIUM")
  businessImpact           String                 @default("MEDIUM")
  estimatedHours           Int                    @default(0)
  evidenceRequirements     String[]               @default([])
  organizationId           String
  createdAt                DateTime               @default(now())
  updatedAt                DateTime               @updatedAt
  
  organization             Organization           @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  tasks                    ProboTask[]
  evidences                ProboEvidence[]
  measures                 ProboMeasure[]

  @@index([organizationId])
  @@index([controlId])
  @@map("probo_controls")
}

model ProboTask {
  id             String       @id @default(cuid())
  title          String
  description    String
  priority       String       @default("MEDIUM")
  estimatedHours Int          @default(0)
  dueDate        DateTime?
  assignedTo     String?
  assignedBy     String?
  controlId      String
  organizationId String
  status         String       @default("TODO")
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  
  control        ProboControl @relation(fields: [controlId], references: [id], onDelete: Cascade)
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([controlId])
  @@index([organizationId])
  @@map("probo_tasks")
}

model ProboEvidence {
  id             String       @id @default(cuid())
  title          String
  description    String?
  validUntil     DateTime?
  status         String       @default("PENDING")
  controlId      String?
  organizationId String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  
  control        ProboControl? @relation(fields: [controlId], references: [id], onDelete: Cascade)
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([controlId])
  @@map("probo_evidence")
}

model ProboMeasure {
  id                 String       @id @default(cuid())
  controlId          String
  effectivenessScore Int          @default(50)
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt
  
  control            ProboControl @relation(fields: [controlId], references: [id], onDelete: Cascade)

  @@index([controlId])
  @@map("probo_measures")
}

model VendorAssessment {
  id                String            @id @default(cuid())
  vendorName        String
  vendorUrl         String?
  overallRiskScore  Int
  securityScore     Int
  complianceScore   Int
  financialScore    Int
  operationalScore  Int
  assessmentMethod  String            @default("MANUAL")
  assessorId        String
  aiFindings        Json?
  recommendations   String[]          @default([])
  assessmentDate    DateTime          @default(now())
  organizationId    String
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  
  organization      Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  findings          VendorFinding[]

  @@index([organizationId])
  @@index([vendorName])
  @@map("vendor_assessments")
}

model VendorFinding {
  id             String           @id @default(cuid())
  category       String
  severity       String
  title          String
  description    String
  remediation    String
  status         String           @default("OPEN")
  dueDate        DateTime?
  assessmentId   String
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  
  assessment     VendorAssessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)

  @@index([assessmentId])
  @@map("vendor_findings")
}

model ComplianceFramework {
  id             String                      @id @default(cuid())
  name           String
  version        String?
  description    String?
  organizationId String
  createdAt      DateTime                    @default(now())
  updatedAt      DateTime                    @updatedAt
  
  organization   Organization                @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  requirements   ComplianceFrameworkRequirement[]

  @@index([organizationId])
  @@index([name])
  @@map("compliance_frameworks")
}

model ComplianceFrameworkRequirement {
  id                    String              @id @default(cuid())
  requirementId         String
  title                 String
  description           String?
  status                String              @default("NOT_STARTED")
  frameworkId           String
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  
  framework             ComplianceFramework @relation(fields: [frameworkId], references: [id], onDelete: Cascade)

  @@index([frameworkId])
  @@index([requirementId])
  @@map("compliance_framework_requirements")
}

enum UserRole {
  ADMIN
  RISK_MANAGER
  AUDITOR
  USER
}

enum RiskCategory {
  OPERATIONAL
  FINANCIAL
  STRATEGIC
  COMPLIANCE
  TECHNOLOGY
}

enum RiskStatus {
  IDENTIFIED
  ASSESSED
  MITIGATED
  CLOSED
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ControlType {
  PREVENTIVE
  DETECTIVE
  CORRECTIVE
  DIRECTIVE
  COMPENSATING
}

enum ControlStatus {
  PLANNED
  IMPLEMENTED
  TESTING
  OPERATIONAL
  REMEDIATION
  DISABLED
  ACTIVE
  INACTIVE
}

enum ControlCategory {
  TECHNICAL
  ADMINISTRATIVE
  PHYSICAL
  OPERATIONAL
  MANAGEMENT
}

enum AutomationLevel {
  MANUAL
  SEMI_AUTOMATED
  FULLY_AUTOMATED
}

enum EffectivenessRating {
  NOT_EFFECTIVE
  PARTIALLY_EFFECTIVE
  LARGELY_EFFECTIVE
  FULLY_EFFECTIVE
}

enum ControlEffort {
  LOW
  MEDIUM
  HIGH
}

enum QuestionnaireStatus {
  DRAFT
  ACTIVE
  COMPLETED
  ARCHIVED
}

enum WorkflowType {
  APPROVAL
  REVIEW
  ASSESSMENT
  CUSTOM
}

enum WorkflowStatus {
  DRAFT
  ACTIVE
  COMPLETED
  ARCHIVED
}

enum WorkflowStepType {
  APPROVAL
  REVIEW
  ACTION
  NOTIFICATION
}

enum StepStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  REJECTED
  SKIPPED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ReportType {
  RISK_ASSESSMENT
  CONTROL_EFFECTIVENESS
  COMPLIANCE
  AUDIT
  EXECUTIVE_DASHBOARD
}

enum ReportStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum TaskType {
  RISK_ASSESSMENT
  CONTROL_TESTING
  DOCUMENT_REVIEW
  WORKFLOW_STEP
  CUSTOM
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  COMPLETED
  CANCELLED
  OVERDUE
}

enum MessageType {
  DIRECT
  GROUP
  BROADCAST
}

enum MessageStatus {
  SENT
  DELIVERED
  READ
}

enum EntityType {
  RISK
  CONTROL
  DOCUMENT
  TASK
  WORKFLOW
  QUESTIONNAIRE
  REPORT
  USER
}

enum NotificationType {
  SUCCESS
  ERROR
  WARNING
  INFO
  MENTION
  TASK_ASSIGNED
  WORKFLOW_UPDATE
  APPROVAL_REQUIRED
  COMMENT_CREATED
  DOCUMENT_SHARED
  RISK_UPDATED
  CONTROL_UPDATED
  SUBSCRIPTION_CANCELED
  PAYMENT_SUCCEEDED
  PAYMENT_FAILED
  TRIAL_ENDING
  NOTIFICATION_DIGEST
}

enum ActivityType {
  CREATED
  UPDATED
  DELETED
  READ
  APPROVED
  REJECTED
  SUBMITTED
  COMPLETED
  ASSIGNED
  COMMENTED
  UPLOADED
  DOWNLOADED
  EXPORTED
  IMPORTED
}

enum SpreadsheetType {
  RCSA_ASSESSMENT
  RISK_REGISTER
  CONTROL_MATRIX
  COMPLIANCE_TRACKER
  VENDOR_ASSESSMENT
  AUDIT_FINDINGS
  INCIDENT_TRACKER
  CUSTOM
}

enum ColumnDataType {
  TEXT
  NUMBER
  DATE
  DATETIME
  BOOLEAN
  DROPDOWN
  MULTI_SELECT
  USER_REFERENCE
  RISK_REFERENCE
  CONTROL_REFERENCE
  TASK_REFERENCE
  CALCULATED
  RATING
  CURRENCY
  PERCENTAGE
  EMAIL
  URL
  PHONE
  FILE_ATTACHMENT
}

enum SpreadsheetPermissionType {
  OWNER
  EDITOR
  COMMENTER
  VIEWER
}
